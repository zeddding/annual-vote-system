<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Då¹´ä¼šæŠ½å¥–ç³»ç»Ÿ - æœ¬åœ°æé€Ÿç‰ˆ</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¯</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <script>
        // é¢„åŠ è½½å…³é”®èµ„æº
        if (window.performance) {
            performance.mark('page-start');
        }
    </script>
    
    <style>
        /* === æ ¸å¿ƒå˜é‡ === */
        :root {
            --neon-purple: #b900ff;
            --neon-blue: #00eaff;
            --neon-pink: #ff0055;
            --neon-gold: #ffd700;
            --bg-dark: #0b0d17;
            --panel-bg: rgba(5, 5, 10, 0.95);
        }

        /* === åŸºç¡€æ ·å¼ === */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background: var(--bg-dark); 
            font-family: 'Microsoft YaHei', sans-serif; color: #fff; 
        }
        
        #app { 
            position: relative; width: 100%; height: 100%; 
            background: linear-gradient(135deg, 
                #0b0d17 0%, 
                #090979 25%, 
                #00d4ff 50%, 
                #ff00ff 75%, 
                #0b0d17 100%);
            background-size: cover;
            background-attachment: fixed;
        }

        /* === åŠ è½½é®ç½©ä¼˜åŒ– === */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.3s;
        }
        .loader-bar {
            width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; overflow: hidden;
        }
        .loader-progress {
            width: 0%; height: 100%; background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue);
            transition: width 0.2s;
        }

        /* === ç•Œé¢å¸ƒå±€ === */
        #canvas-container { 
            width: 100%; height: 92%; display: flex; justify-content: center; align-items: center; 
            z-index: 10; position: relative; 
            filter: drop-shadow(0 0 15px rgba(0, 234, 255, 0.3));
        }
        .top-bar { position: absolute; top: 30px; right: 30px; z-index: 50; display: flex; gap: 15px; }
        
        .icon-btn {
            width: 50px; height: 50px; background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue);
            text-align: center; line-height: 50px; cursor: pointer; font-size: 22px;
            color: var(--neon-blue); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px rgba(0, 234, 255, 0.1); backdrop-filter: blur(5px);
        }
        .icon-btn:hover { background: var(--neon-blue); color: #000; transform: scale(1.1); box-shadow: 0 0 20px var(--neon-blue); }
        .icon-btn.danger { border-color: var(--neon-pink); color: var(--neon-pink); }
        .icon-btn.danger:hover { background: var(--neon-pink); color: #fff; box-shadow: 0 0 20px var(--neon-pink); }

        .control-bar { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 8%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px);
            display: flex; justify-content: center; align-items: center; z-index: 20;
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }

        select { 
            padding: 12px 25px; font-size: 20px; background: rgba(0,0,0,0.5); color: var(--neon-blue);
            border: 2px solid var(--neon-blue); border-radius: 4px; outline: none; cursor: pointer; margin-right: 40px;
            font-family: 'Orbitron', sans-serif; letter-spacing: 1px;
        }

        .btn-main {
            padding: 12px 60px; font-size: 28px; font-weight: 800; border: none; cursor: pointer;
            text-transform: uppercase; letter-spacing: 4px; min-width: 260px;
            font-family: 'Rajdhani', sans-serif; border-radius: 2px; transition: 0.1s; position: relative;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-start { 
            background: linear-gradient(90deg, #ff9f43, #ff6b6b); color: #fff; 
            box-shadow: 0 0 30px rgba(255, 107, 107, 0.4);
            text-shadow: 0 2px 0 rgba(0,0,0,0.3);
        }
        .btn-start:active:not(:disabled) { transform: scale(0.95); box-shadow: 0 0 10px rgba(255, 107, 107, 0.4); }
        .btn-stop { 
            background: linear-gradient(90deg, #ff0055, #ff0000); color: #fff; 
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.6); animation: pulse-red 0.5s infinite;
        }
        @keyframes pulse-red { 0% { box-shadow: 0 0 20px #f00; } 100% { box-shadow: 0 0 50px #f00; } }
        .btn-main:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }

        /* === å¼¹çª— === */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 3000; backdrop-filter: blur(3px); 
            justify-content: center; align-items: center; flex-direction: column;
            perspective: 1000px;
        }
        .modal-panel {
            background: rgba(15, 15, 30, 0.85); width: 700px; max-width: 95%; max-height: 90vh;
            padding: 0; border: 1px solid rgba(0, 234, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 100px rgba(0,0,0,0.8);
            color: #eee; display: flex; flex-direction: column; position: relative;
            backdrop-filter: blur(15px);
            transform: rotateX(0deg); animation: panel-open 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes panel-open { from { opacity: 0; transform: rotateX(-20deg) translateY(50px); } to { opacity: 1; transform: rotateX(0) translateY(0); } }
        
        .modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
        .modal-header h2 { margin: 0; font-family: 'Orbitron', sans-serif; color: var(--neon-gold); text-transform: uppercase; letter-spacing: 2px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 32px; cursor: pointer; color: var(--neon-blue); z-index: 10; opacity: 0.7; }
        .close-btn:hover { opacity: 1; transform: rotate(90deg); transition: 0.3s; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; }

        /* === ğŸ† ä¸­å¥–å±•ç¤º === */
        #winner-modal .modal-panel { width: 90%; max-width: 1400px; text-align: center; border: 2px solid var(--neon-gold); }
        .winner-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; }
        
        .winner-item { 
            display: flex; flex-direction: column; align-items: center; width: 180px; padding: 20px 10px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 100%);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        .winner-item::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% { left: -100%; } 20% { left: 100%; } 100% { left: 100%; } }

        .winner-item img { 
            width: 130px; height: 130px; border-radius: 50%; border: 4px solid var(--neon-gold); 
            object-fit: cover; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); 
            animation: shake-gentle 3s infinite ease-in-out;
        }
        .winner-item span { 
            margin-top: 15px; font-size: 24px; font-weight: bold; color: var(--neon-blue); 
            text-shadow: 0 0 10px var(--neon-blue); font-family: 'Rajdhani', sans-serif; 
            animation: shake-gentle 3.2s infinite ease-in-out reverse; z-index: 1;
        }

        /* ğŸ”¥ ç‰¹ç­‰å¥– */
        .grand-prize-mode .modal-header h2 { 
            font-size: 70px; color: #ffd700; text-shadow: 0 0 50px #ffd700, 0 0 100px #ff0000; 
            animation: pulse-gold 0.2s infinite alternate;
        }
        .grand-prize-mode .winner-item {
            width: 320px; padding: 40px 20px;
            background: rgba(255, 215, 0, 0.05); border: 2px solid #ffd700;
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.3);
        }
        .grand-prize-mode .winner-item img {
            width: 250px; height: 250px; border: 8px solid #fff; box-shadow: 0 0 100px #ff4500;
            animation: glitch-anim 0.3s infinite linear alternate-reverse;
        }
        .grand-prize-mode .winner-item span {
            font-size: 50px; color: #fff; text-shadow: 2px 2px #ff00de, -2px -2px #00eaff;
            animation: glitch-text 0.3s infinite linear alternate-reverse;
        }

        /* å†²å‡»æ³¢ */
        @keyframes shockwave { 0% { transform: scale(0.8); opacity: 0; border: 20px solid #fff; } 50% { opacity: 1; } 100% { transform: scale(2); opacity: 0; border: 0px solid #fff; } }
        .shockwave-active { animation: shockwave 0.5s ease-out forwards; position: absolute; width: 100vw; height: 100vh; pointer-events: none; z-index: 2000; top:0; left:0; border-radius: 50%; }

        @keyframes shake-gentle { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0, -5px)} }
        @keyframes pulse-gold { from{transform:scale(1); opacity:0.8} to{transform:scale(1.05); opacity:1} }
        @keyframes glitch-anim { 0% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 80% { transform: translate(2px, -2px) } 100% { transform: translate(0) } }
        @keyframes glitch-text { 0% { clip-path: inset(20% 0 80% 0); transform: translate(-2px,0) } 20% { clip-path: inset(60% 0 10% 0); transform: translate(2px,0) } 40% { clip-path: inset(40% 0 50% 0); transform: translate(-2px,0) } 60% { clip-path: inset(80% 0 5% 0); transform: translate(2px,0) } 80% { clip-path: inset(10% 0 60% 0); transform: translate(-2px,0) } 100% { clip-path: inset(30% 0 30% 0); transform: translate(2px,0) } }

        /* === ç‰¹æ•ˆå±‚ === */
        #coin-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000; }
        .coin {
            position: fixed; top: -60px; width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 25px #ffd700;
            will-change: transform; animation: fall linear forwards;
        }
        .coin::after { content: '$'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #b8860b; font-weight: 900; font-family: 'Rajdhani'; font-size: 28px; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }

        #fire-container {
            position: fixed; bottom: -20px; left: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 8000; display: none; justify-content: center; 
            filter: contrast(1.5) blur(1px);
        }
        .fire-particle {
            position: absolute; bottom: -100px; width: 60px; height: 60px; 
            background: radial-gradient(circle, #ffeb3b, #ff5722, transparent 70%);
            border-radius: 50%; mix-blend-mode: screen; opacity: 0;
            will-change: transform, opacity; animation: rise 1s ease-out forwards;
        }
        .grand-fire { background: radial-gradient(circle, #fff, #00eaff, transparent 70%); width: 100px; height: 100px; }
        @keyframes rise { 0% { transform: translateY(0) scale(1); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-90vh) scale(0); opacity: 0; } }

        /* === åˆ—è¡¨ä¸è¡¨å• === */
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { 
            background: rgba(255, 255, 255, 0.05); padding: 15px; margin-bottom: 12px; 
            border: 1px solid rgba(0, 234, 255, 0.3); display: flex; justify-content: space-between; align-items: center; 
            border-left: 4px solid var(--neon-gold); cursor: pointer; transition: 0.2s;
        }
        .history-item:hover { background: rgba(0, 234, 255, 0.1); border-color: var(--neon-blue); }
        .history-avatars img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #fff; margin-left: -10px; position: relative; z-index: 1; }
        .history-left { display: flex; flex-direction: column; }
        .history-name { font-size: 20px; color: var(--neon-gold); font-family: 'Orbitron'; margin-bottom: 5px; }
        .history-count { font-size: 12px; color: #aaa; }

        .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; }
        .roster-item { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .roster-item img { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--neon-purple); object-fit: cover; background: #000; }
        .roster-item span { margin-top: 5px; color: #ccc; font-size: 14px; }
        .roster-item.is-winner img { filter: grayscale(1); opacity: 0.3; border-color: #333; }
        .roster-item.is-winner span { text-decoration: line-through; color: #555; }

        .form-group label { color: var(--neon-blue); font-family: 'Orbitron', sans-serif; display:block; margin-bottom:5px;}
        input[type="file"] { background: rgba(0,0,0,0.5); border: 1px solid var(--neon-blue); color: #fff; padding: 10px; width: 100%; box-sizing: border-box; }
        
        /* ==================== æŠ•ç¥¨ç›¸å…³æ ·å¼ ==================== */
        .vote-item {
            transition: all 0.3s ease;
        }
        
        .vote-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes progress-pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .setting-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            border: 1px solid rgba(0,234,255,0.2);
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            color: var(--neon-blue);
            font-weight: bold;
        }
        
        .setting-item input[type="number"],
        .setting-item input[type="text"] {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--neon-blue);
            color: #fff;
            border-radius: 3px;
        }
        
        .program-list-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        
        .program-list-item input {
            flex: 1;
            margin-right: 10px;
        }
        
        .program-list-item button {
            background: var(--neon-pink);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .add-program-btn {
            background: var(--neon-blue);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .time-display {
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
        }
    </style>
</head>
<body>

<div id="loader">
    <div style="font-family:'Orbitron'; color:var(--neon-blue); font-size:24px; margin-bottom:10px;">SYSTEM LOADING</div>
    <div class="loader-bar"><div class="loader-progress" id="loader-progress"></div></div>
</div>

<div id="coin-container"></div>
<div id="fire-container"></div>
<div id="shockwave-layer"></div>

<div id="app">
    <audio id="bgm" loop preload="none"></audio>
    <audio id="sound-start" loop preload="none"></audio>
    <audio id="sound-roll" loop preload="none"></audio>
    <audio id="sound-win" preload="none"></audio>

    <div class="top-bar">
        <div class="icon-btn" onclick="openRoster()" title="å‚é€‰åå•">ğŸ‘¥</div>
        <div class="icon-btn" onclick="openHistory()" title="ä¸­å¥–è®°å½•">ğŸ“‹</div>
        <div class="icon-btn" onclick="openVotePanel()" title="æŠ•ç¥¨ç»“æœ">ğŸ—³ï¸</div>
        <div class="icon-btn" onclick="generateVoteQRCode()" title="æŠ•ç¥¨äºŒç»´ç ">ğŸ“±</div>
        <div class="icon-btn" onclick="openSettings()" title="è®¾ç½®">âš™ï¸</div>
        <div class="icon-btn danger" onclick="resetSystem()" title="é‡ç½®æŠ½å¥–">ğŸ”„</div>
    </div>

    <div id="canvas-container">
        <canvas id="myCanvas" width="800" height="800"></canvas>
    </div>

    <div id="tags" style="display: none;"><ul id="member-list"></ul></div>

    <div class="control-bar">
        <select id="prize-select" onchange="checkPrizeStatus()"></select>
        <button id="toggle-btn" class="btn-main btn-start" onclick="toggleLottery()">START ENGINE â–¶</button>
    </div>

    <div id="winner-modal" class="modal-overlay" onclick="/* æ²‰æµ¸å¼ä¸å…³é—­ */">
        <div class="modal-panel" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="close-btn" onclick="closeWinner()">Ã—</div>
                <h2 id="win-title">ğŸ‰ æ­å–œä¸­å¥– ğŸ‰</h2>
            </div>
            <div class="modal-body">
                <div id="win-grid" class="winner-grid"></div>
                <div style="margin-top:50px; font-size:16px; color: #aaa; cursor:pointer;" onclick="closeWinner()">[ ç‚¹å‡»å…³é—­ç‰¹æ•ˆ ]</div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-header">
                <div class="close-btn" onclick="document.getElementById('history-modal').style.display='none'">Ã—</div>
                <h2>ğŸ“‹ ä¸­å¥–è®°å½•</h2>
            </div>
            <div class="modal-body">
                <ul id="history-list-dom" class="history-list"></ul>
            </div>
        </div>
    </div>

    <div id="roster-modal" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-header">
                <div class="close-btn" onclick="document.getElementById('roster-modal').style.display='none'">Ã—</div>
                <h2>ğŸ‘¥ å‚é€‰åå• [<span id="roster-count">0</span>]</h2>
            </div>
            <div class="modal-body">
                <div id="roster-grid" class="roster-grid"></div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-panel" style="width: 600px;">
            <div class="modal-header">
                <div class="close-btn" onclick="document.getElementById('settings-modal').style.display='none'">Ã—</div>
                <h2>âš™ï¸ è®¾ç½®</h2>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>1. åå• Excel</label><input type="file" id="set-excel" accept=".xlsx, .xls"></div>
                <div class="form-group"><label>2. å¤´åƒæ–‡ä»¶å¤¹</label><input type="file" id="set-folder" webkitdirectory directory multiple></div>
                <div class="form-group">
                    <label>3. ç´ ææ›¿æ¢</label>
                    <div style="margin:5px 0"><small>èƒŒæ™¯å›¾:</small> <input type="file" id="set-bg" accept="image/*"></div>
                    <div style="margin:5px 0"><small>BGM:</small> <input type="file" id="set-music" accept="audio/*"></div>
                    <div style="margin:5px 0"><small>å¼€å§‹éŸ³æ•ˆ:</small> <input type="file" id="set-start-sound" accept="audio/*"></div>
                    <div><small>ä¸­å¥–éŸ³æ•ˆ:</small> <input type="file" id="set-win-sound" accept="audio/*"></div>
                </div>
                <button class="btn-main btn-start" style="width:100%; margin-top:20px;" onclick="saveSettings()">ä¿å­˜å¹¶é‡å¯</button>
                <div id="save-status" style="margin-top:10px; color:var(--neon-gold); text-align:center;"></div>
            </div>
        </div>
    </div>
    
    <div id="vote-modal" class="modal-overlay">
        <div class="modal-panel" style="width: 90%; max-width: 1400px;">
            <div class="modal-header">
                <div class="close-btn" onclick="closeVotePanel()">Ã—</div>
                <h2>ğŸ“Š èŠ‚ç›®æŠ•ç¥¨å®æ—¶æ’è¡Œæ¦œ</h2>
                <div style="display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                    <button id="vote-start-btn" class="btn-main btn-start" style="padding: 8px 20px; font-size: 16px;">å¼€å§‹æŠ•ç¥¨</button>
                    <button id="vote-stop-btn" class="btn-main btn-stop" style="padding: 8px 20px; font-size: 16px;">ç»“æŸæŠ•ç¥¨</button>
                    <button id="vote-reset-btn" class="btn-main" style="padding: 8px 20px; font-size: 16px; background: #666;" onclick="resetVoteSystem()">é‡ç½®æŠ•ç¥¨</button>
                    <button class="btn-main" onclick="openVoteSettings()" style="padding: 8px 20px; font-size: 16px; background: var(--neon-purple);">æŠ•ç¥¨è®¾ç½®</button>
                </div>
                <div id="vote-time-display" class="time-display" style="margin-top: 10px; font-size: 18px;"></div>
            </div>
            <div class="modal-body">
                <div id="vote-results" style="display: flex; flex-direction: column; gap: 15px;"></div>
            </div>
        </div>
    </div>
    
    <div id="vote-settings-modal" class="modal-overlay">
        <div class="modal-panel" style="width: 800px; max-width: 95%;">
            <div class="modal-header">
                <div class="close-btn" onclick="closeVoteSettings()">Ã—</div>
                <h2>âš™ï¸ æŠ•ç¥¨è®¾ç½®</h2>
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label>æŠ•ç¥¨å€’è®¡æ—¶é•¿ (ç§’):</label>
                    <input type="number" id="vote-duration" min="30" value="60">
                </div>
                
                <div class="setting-item">
                    <label>èŠ‚ç›®åˆ—è¡¨:</label>
                    <div id="program-list-container"></div>
                    <button class="add-program-btn" onclick="addProgramItem()">æ·»åŠ æ–°èŠ‚ç›®</button>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-main btn-start" onclick="saveVoteSettings()" style="padding: 10px 20px; font-size: 16px;">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <div id="qrcode-modal" class="modal-overlay">
        <div class="modal-panel" style="width: 500px; text-align: center;">
            <div class="modal-header">
                <div class="close-btn" onclick="document.getElementById('qrcode-modal').style.display='none'">Ã—</div>
                <h2>ğŸ“± æŠ•ç¥¨äºŒç»´ç </h2>
            </div>
            <div class="modal-body">
                <div id="qrcode" style="width: 300px; height: 300px; margin: 0 auto; background: #fff; padding: 20px; display: flex; align-items: center; justify-content: center;"></div>
                <p style="margin-top: 20px; color: #aaa; word-break: break-all;">
                    <span id="vote-url" style="color: var(--neon-blue); font-size: 14px;"></span>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // å¼‚æ­¥åŠ è½½å¤–éƒ¨è„šæœ¬
    const scripts = [
        './qrcode.min.js',
        './tagcanvas.min.js',
        './xlsx.full.min.js',
        './umd.js',
        './confetti.min.js'
    ];
    
    let loadedScripts = 0;
    const totalScripts = scripts.length;
    
    function loadNextScript() {
        if (loadedScripts >= totalScripts) {
            document.getElementById('loader-progress').style.width = '50%';
            initApp();
            return;
        }
        
        const script = document.createElement('script');
        script.src = scripts[loadedScripts];
        script.onload = () => {
            loadedScripts++;
            document.getElementById('loader-progress').style.width = Math.floor((loadedScripts / totalScripts) * 50) + '%';
            loadNextScript();
        };
        script.onerror = () => {
            console.warn('åŠ è½½è„šæœ¬å¤±è´¥:', scripts[loadedScripts]);
            loadedScripts++;
            loadNextScript();
        };
        document.head.appendChild(script);
    }
    
    loadNextScript();
    
    // Firebaseé…ç½®
    const firebaseConfig = {
        databaseURL: "https://your-project-id-default-rtdb.firebaseio.com" // è¯·æ›¿æ¢ä¸ºæ‚¨çš„çœŸå®åœ°å€
    };
</script>

<script>
    // === æ ¸å¿ƒå¸¸é‡ä¸å˜é‡ ===
    const DB_KEY = 'lottery_db_v15_speedgod_fix';
    const PRIZE_CONFIG = {
        3: { name: "ä¸‰ç­‰å¥–", count: 20 },
        2: { name: "äºŒç­‰å¥–", count: 12 },
        1: { name: "ä¸€ç­‰å¥–", count: 5 },
        0: { name: "ç‰¹ç­‰å¥–", count: 2 } 
    };

    let allMembers = [];      
    let prizeHistory = {};    
    let isRolling = false;
    let objectUrls = [];
    let effectsInterval = null, coinInterval = null, fireInterval = null;    

    // Firebase æŠ•ç¥¨ç›¸å…³
    let voteRef = null;
    let voteTimer = null;
    let currentVoteData = null;

    // é»˜è®¤èŠ‚ç›®æ•°æ®
    const defaultPrograms = [
        { name: "å¼€åœºèˆè¹ˆã€Šæœªæ¥ä¹‹å…‰ã€‹", performer: "èˆè¹ˆé˜Ÿ", votes: 0 },
        { name: "æ­Œæ›²ä¸²çƒ§ã€Šå²æœˆå¦‚æ­Œã€‹", performer: "å¸‚åœºéƒ¨", votes: 0 },
        { name: "å°å“ã€ŠåŠå…¬å®¤çš„æ•…äº‹ã€‹", performer: "ç ”å‘éƒ¨", votes: 0 },
        { name: "é­”æœ¯è¡¨æ¼”ã€Šæ¢¦å¹»ä¹‹å¤œã€‹", performer: "ç‰¹é‚€å˜‰å®¾", votes: 0 }
    ];

    // === å¤´åƒç”Ÿæˆ ===
    function generateAvatar(name) {
        const colors = ['#b900ff', '#00eaff', '#ff0055', '#2d3436', '#0984e3'];
        const bgColor = colors[name.charCodeAt(0) % colors.length];
        const initials = name.charAt(0).toUpperCase();
        const svg = `<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45" fill="${bgColor}" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
            <text x="50" y="55" text-anchor="middle" fill="#fff" font-family="Arial" font-size="40" font-weight="bold">${initials}</text>
        </svg>`;
        return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    // === åˆå§‹åŒ–åº”ç”¨ ===
    async function initApp() {
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                voteRef = firebase.database().ref('currentVote');
            }
            
            document.getElementById('loader-progress').style.width = '70%';
            
            await Promise.all([loadData(), initUI()]);
            window.addEventListener('resize', reloadCanvas);
            
            document.getElementById('loader-progress').style.width = '100%';
            setTimeout(() => { 
                document.getElementById('loader').style.display = 'none'; 
                initFirebaseVoteSystem();
            }, 500);
        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            alert("åˆå§‹åŒ–å¤±è´¥: " + error.message);
        }
    }

    function initUI() {
        const select = document.getElementById('prize-select');
        select.innerHTML = '';
        Object.keys(PRIZE_CONFIG).sort((a,b) => b-a).forEach(k => {
            const opt = document.createElement('option');
            opt.value = k;
            opt.innerText = `${PRIZE_CONFIG[k].name}`;
            select.appendChild(opt);
        });
        checkPrizeStatus(); 
    }

    function reloadCanvas() {
        const c = document.getElementById('myCanvas');
        const p = document.getElementById('canvas-container');
        c.width = p.offsetWidth; c.height = p.offsetHeight;
        if(!isRolling && window.TagCanvas) try{ TagCanvas.Reload('myCanvas'); }catch(e){}
    }

    async function loadData() {
        const data = await idbKeyval.get(DB_KEY);
        if (data) {
            const loadBlob = (id, blob) => { if(blob) document.getElementById(id).src = URL.createObjectURL(blob); };
            loadBlob('bgm', data.musicBlob);
            loadBlob('sound-win', data.winSoundBlob);
            loadBlob('sound-start', data.startSoundBlob);
            
            if (data.bgBlob) document.getElementById('app').style.backgroundImage = `url(${URL.createObjectURL(data.bgBlob)})`;
            if (data.history) prizeHistory = data.history; 
            
            if (data.members) {
                allMembers = [];
                const batchSize = 20;
                for (let i = 0; i < data.members.length; i += batchSize) {
                    const batch = data.members.slice(i, i + batchSize);
                    const processedBatch = batch.map(m => {
                        let url;
                        if (m.imgFileName && data.imgBlobs && data.imgBlobs[m.imgFileName]) {
                            url = URL.createObjectURL(data.imgBlobs[m.imgFileName]);
                            objectUrls.push(url);
                        } else {
                            url = generateAvatar(m.name);
                        }
                        return { name: m.name, img: url };
                    });
                    allMembers.push(...processedBatch);
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            } else { useDemoData(); }
        } else { useDemoData(); }
        
        renderTagCloud();
        setTimeout(() => initTagCanvas(), 100);
    }

    function useDemoData() {
        allMembers = Array.from({length: 80}, (_, i) => {
            const name = `å‘˜å·¥${i+1}`;
            return { name: name, img: generateAvatar(name) };
        });
    }

    function getLeftPool() {
        const allWinners = Object.values(prizeHistory).flat().map(w => w.name);
        return allMembers.filter(m => !allWinners.includes(m.name));
    }

    function renderTagCloud() {
        const pool = getLeftPool();
        const ul = document.getElementById('member-list');
        ul.innerHTML = '';
        const list = pool.length > 0 ? pool : [{name:"æŠ½å¥–ç»“æŸ", img: generateAvatar("å®Œ")}];
        list.forEach(m => {
            const li = document.createElement('li');
            li.innerHTML = `<a href="#" onclick="return false;" style="font-size:18px; color:#00eaff;"><img src="${m.img}" width="90" height="90" style="border-radius:50%; border:3px solid #b900ff; box-shadow:0 0 15px #b900ff;">${m.name}</a>`;
            ul.appendChild(li);
        });
    }

    function initTagCanvas() {
        try {
            TagCanvas.Start('myCanvas', 'tags', {
                textColour: null, outlineColour: 'transparent', reverse: true, depth: 0.8,
                maxSpeed: 0.05, initial: [0.1, -0.1], imageMode: 'both', imagePosition: 'top', 
                lock: 'xy', clickToFront: 600, shadow: '#00eaff', shadowBlur: 10, weight: true, weightMode: 'both'
            });
        } catch(e){}
    }

    function toggleLottery() {
        const btn = document.getElementById('toggle-btn');
        const rollSound = document.getElementById('sound-roll');
        const winSound = document.getElementById('sound-win');
        const bgm = document.getElementById('bgm');
        const startSound = document.getElementById('sound-start');

        if (bgm && bgm.src && bgm.paused) bgm.play().catch(()=>{});

        if (!isRolling) {
            const type = document.getElementById('prize-select').value;
            const config = PRIZE_CONFIG[type];
            const alreadyDrawn = (prizeHistory[type] || []).length;
            const pool = getLeftPool();

            if (alreadyDrawn >= config.count) { alert("æœ¬è½®å·²ç»“æŸ"); return; }
            if (pool.length === 0) { alert("å¥–æ± å·²ç©º"); return; }

            if (startSound && startSound.src) {
                startSound.currentTime = 0; startSound.play().catch(()=>{});
            }
            isRolling = true;
            btn.innerText = "STOP ENGINE â– ";
            btn.className = "btn-main btn-stop";
            TagCanvas.SetSpeed('myCanvas', [2.0, 1.5]); 
            if (rollSound && rollSound.src) {
                rollSound.currentTime = 0; rollSound.play().catch(()=>{});
            }
        } else {
            isRolling = false;
            btn.innerText = "START ENGINE â–¶";
            btn.className = "btn-main btn-start";
            TagCanvas.SetSpeed('myCanvas', [0.05, -0.05]);
            
            if (startSound) { startSound.pause(); startSound.currentTime = 0; }
            if (rollSound) { rollSound.pause(); rollSound.currentTime = 0; }
            if (winSound && winSound.src) { winSound.currentTime = 0; winSound.play().catch(()=>{}); }

            batchDraw();
        }
    }

    async function batchDraw() {
        const type = document.getElementById('prize-select').value;
        const config = PRIZE_CONFIG[type];
        const currentHistory = prizeHistory[type] || [];
        const needed = config.count - currentHistory.length; 
        
        let pool = getLeftPool();
        const countToDraw = Math.min(needed, pool.length);
        if (countToDraw <= 0) return;

        const winners = [];
        for (let i = 0; i < countToDraw; i++) {
            const idx = Math.floor(Math.random() * pool.length);
            winners.push(pool[idx]);
            pool.splice(idx, 1);
        }

        if (!prizeHistory[type]) prizeHistory[type] = [];
        prizeHistory[type].push(...winners);

        const dbData = (await idbKeyval.get(DB_KEY)) || {};
        dbData.history = prizeHistory;
        await idbKeyval.set(DB_KEY, dbData);

        const isGrand = (type == 0); 
        showWinnersModal(config.name, winners, isGrand);
        checkPrizeStatus();
        setTimeout(() => { renderTagCloud(); TagCanvas.Reload('myCanvas'); }, 1000);
    }

    function showWinnersModal(title, winners, isGrand) {
        const modal = document.getElementById('winner-modal');
        const panel = modal.querySelector('.modal-panel');
        const grid = document.getElementById('win-grid');
        document.getElementById('win-title').innerHTML = isGrand ? `ğŸ‰ ${title} ğŸ‰` : title;
        
        panel.parentElement.className = isGrand ? 'modal-overlay grand-prize-mode' : 'modal-overlay';
        if (isGrand) {
            const s = document.createElement('div'); s.className = 'shockwave-active';
            document.body.appendChild(s); setTimeout(() => s.remove(), 600);
        }

        grid.innerHTML = '';
        winners.forEach((w) => {
            const div = document.createElement('div');
            div.className = 'winner-item'; 
            div.innerHTML = `<img src="${w.img}" onerror="this.src='${generateAvatar(w.name)}'"><span>${w.name}</span>`;
            grid.appendChild(div);
        });

        modal.style.display = 'flex';
        startAllEffects(isGrand);
    }

    function closeWinner() { 
        document.getElementById('winner-modal').style.display = 'none';
        stopAllEffects(); 
    }

    function startAllEffects(isGrand) {
        if (window.confetti) {
            const duration = isGrand ? 600 : 1500; 
            const count = isGrand ? 200 : 80; 
            effectsInterval = setInterval(() => {
                confetti({
                    particleCount: count, spread: 120, origin: { y: 0.6 },
                    zIndex: 10000,
                    colors: isGrand ? ['#ffd700', '#ffffff', '#ff0000'] : ['#00eaff', '#b900ff']
                });
            }, duration);
        }
    }

    function stopAllEffects() {
        if(effectsInterval) clearInterval(effectsInterval);
    }

    function checkPrizeStatus() {
        const select = document.getElementById('prize-select');
        const btn = document.getElementById('toggle-btn');
        const options = select.options;
        for (let i = 0; i < options.length; i++) {
            const type = options[i].value;
            const config = PRIZE_CONFIG[type];
            const drawn = (prizeHistory[type] || []).length;
            options[i].innerText = drawn >= config.count ? `[å·²å®Œ] ${config.name}` : `${config.name} [å‰©${config.count - drawn}]`;
        }
        const currentType = select.value;
        const currentDrawn = (prizeHistory[currentType] || []).length;
        if(currentDrawn >= PRIZE_CONFIG[currentType].count) {
            btn.innerText = "æœ¬è½®å·²å®Œç»“"; btn.disabled = true;
        } else {
            btn.innerText = "START ENGINE â–¶"; btn.disabled = false;
        }
    }

    function openRoster() {
        const modal = document.getElementById('roster-modal');
        const grid = document.getElementById('roster-grid');
        document.getElementById('roster-count').innerText = allMembers.length;
        grid.innerHTML = '';
        const allWinners = Object.values(prizeHistory).flat().map(w => w.name);
        allMembers.slice(0, 500).forEach(m => {
            const div = document.createElement('div');
            div.className = `roster-item ${allWinners.includes(m.name)?'is-winner':''}`;
            div.innerHTML = `<img src="${m.img}" loading="lazy" onerror="this.src='${generateAvatar(m.name)}'"><span>${m.name}</span>`;
            grid.appendChild(div);
        });
        modal.style.display = 'flex';
    }
    
    function openHistory() {
        const list = document.getElementById('history-list-dom');
        list.innerHTML = '';
        Object.keys(PRIZE_CONFIG).sort((a,b) => a-b).forEach(type => { 
            const history = prizeHistory[type] || [];
            if (history.length === 0) return;
            const li = document.createElement('li');
            li.className = 'history-item';
            let avatars = history.slice(0, 10).map(h => `<img src="${h.img}" onerror="this.src='${generateAvatar(h.name)}'">`).join('');
            if(history.length > 10) avatars += `<span>+${history.length-10}</span>`;
            li.innerHTML = `<div class="history-left"><span class="history-name">${PRIZE_CONFIG[type].name}</span><span class="history-count">${history.length}äºº</span></div><div class="history-avatars" style="display:flex; gap:5px;">${avatars}</div>`;
            list.appendChild(li);
        });
        document.getElementById('history-modal').style.display = 'flex';
    }

    async function resetSystem() {
        if(!confirm("âš ï¸ ç¡®å®šé‡ç½®æŠ½å¥–æ•°æ®å—ï¼Ÿï¼ˆè¿™å°†ä¸ä¼šå½±å“æŠ•ç¥¨ç³»ç»Ÿï¼‰")) return;
        const data = (await idbKeyval.get(DB_KEY)) || {};
        data.history = {}; 
        await idbKeyval.set(DB_KEY, data);
        prizeHistory = {};
        checkPrizeStatus(); renderTagCloud(); TagCanvas.Reload('myCanvas');
    }
    
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    
    async function saveSettings() {
        const status = document.getElementById('save-status');
        status.innerText = "Saving...";
        let dbData = (await idbKeyval.get(DB_KEY)) || {};
        if (!dbData.imgBlobs) dbData.imgBlobs = {};

        const getFile = (id) => { const el = document.getElementById(id); return el && el.files ? el.files[0] : null; };
        const bgFile = getFile('set-bg'); if (bgFile) dbData.bgBlob = bgFile;
        // ... (å…¶ä»–æ–‡ä»¶ä¿å­˜é€»è¾‘çœç•¥ï¼Œä¿æŒåŸæ ·)
        
        const excelInput = document.getElementById('set-excel');
        if (excelInput && excelInput.files[0]) {
            try {
                const json = await parseExcel(excelInput.files[0]);
                const newMembers = [];
                for (let i = 1; i < json.length; i++) { if (json[i][0]) newMembers.push({ name: json[i][0], imgFileName: json[i][1] }); }
                dbData.members = newMembers; dbData.history = {}; 
            } catch(e) { alert("Excel Error"); return; }
        }
        await idbKeyval.set(DB_KEY, dbData);
        location.reload();
    }

    function parseExcel(file) {
        return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = e => {
                const w = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                resolve(XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]], {header: 1}));
            };
            r.readAsArrayBuffer(file);
        });
    }

    // ==================== æŠ•ç¥¨ç³»ç»Ÿé€»è¾‘ (å·²å®Œå…¨é‡å†™é€‚é… vote.html) ====================
    
    async function initFirebaseVoteSystem() {
        if (!voteRef) return;
        
        // ç›‘å¬ currentVote å¯¹è±¡çš„æ‰€æœ‰å˜åŒ–
        voteRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                currentVoteData = data;
                updateVotePanelUI();
                startAdminTimer();
            } else {
                // åˆå§‹åŒ–é»˜è®¤æ•°æ®
                voteRef.set({
                    title: "å¹´ä¼šæœ€å—æ¬¢è¿èŠ‚ç›®è¯„é€‰",
                    active: false,
                    duration: 60,
                    programs: defaultPrograms
                });
            }
        });

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('vote-start-btn').onclick = startVote;
        document.getElementById('vote-stop-btn').onclick = stopVote;
    }

    function startVote() {
        const duration = parseInt(document.getElementById('vote-duration').value) || 60;
        if (!currentVoteData || !currentVoteData.programs) { alert('è¯·å…ˆè®¾ç½®èŠ‚ç›®'); return; }

        // é‡ç½®ç¥¨æ•°å¹¶å¼€å¯æ–°ä¸€è½®
        const newPrograms = currentVoteData.programs.map(p => ({ ...p, votes: 0 }));
        
        voteRef.update({
            active: true,
            startTime: firebase.database.ServerValue.TIMESTAMP, // å…³é”®ï¼šä½¿ç”¨æœåŠ¡å™¨æ—¶é—´æˆ³
            duration: duration,
            programs: newPrograms
        });
    }

    function stopVote() {
        if (!currentVoteData) return;
        voteRef.update({ active: false });
    }

    function resetVoteSystem() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæŠ•ç¥¨æ•°æ®å¹¶é‡ç½®å—ï¼Ÿ')) return;
        voteRef.set({
            title: "å¹´ä¼šæœ€å—æ¬¢è¿èŠ‚ç›®è¯„é€‰",
            active: false,
            duration: 60,
            programs: defaultPrograms
        });
    }

    function updateVotePanelUI() {
        if (!currentVoteData) return;

        // æ›´æ–°çŠ¶æ€æ–‡å­—
        const timeDisplay = document.getElementById('vote-time-display');
        const startBtn = document.getElementById('vote-start-btn');
        const stopBtn = document.getElementById('vote-stop-btn');

        if (currentVoteData.active) {
            timeDisplay.style.color = 'var(--neon-blue)';
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } else {
            timeDisplay.innerText = "æŠ•ç¥¨å·²ç»“æŸ";
            timeDisplay.style.color = 'var(--neon-pink)';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        // æ¸²æŸ“æ’è¡Œæ¦œ
        const container = document.getElementById('vote-results');
        container.innerHTML = '';
        
        const programs = [...(currentVoteData.programs || [])];
        // æŒ‰ç¥¨æ•°æ’åº
        programs.sort((a, b) => (b.votes || 0) - (a.votes || 0));
        
        const maxVotes = programs[0] ? (programs[0].votes || 1) : 1;

        programs.forEach((p, idx) => {
            const votes = p.votes || 0;
            const percent = (votes / maxVotes) * 100;
            const isTop = idx === 0 && votes > 0;
            
            const div = document.createElement('div');
            div.className = 'vote-item';
            div.style.cssText = `background:rgba(0,0,0,0.5); padding:15px; border-radius:8px; border:1px solid ${isTop?'var(--neon-gold)':'#333'}`;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:18px; color:${isTop?'var(--neon-gold)':'#fff'}">${idx+1}. ${p.name}</span>
                    <span style="font-family:'Rajdhani'; font-size:20px; color:var(--neon-blue)">${votes} ç¥¨</span>
                </div>
                <div style="height:10px; background:#333; border-radius:5px; overflow:hidden;">
                    <div style="height:100%; width:${percent}%; background:linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); transition:width 0.5s;"></div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // ä¿®å¤åçš„å€’è®¡æ—¶é€»è¾‘ï¼šåŸºäºæ—¶é—´æˆ³è®¡ç®—
    function startAdminTimer() {
        if (voteTimer) clearInterval(voteTimer);
        
        const update = () => {
            if (!currentVoteData || !currentVoteData.active || !currentVoteData.startTime) return;
            
            const now = Date.now();
            // æ³¨æ„ï¼šFirebaseè¿”å›çš„ startTime æ˜¯æ¯«ç§’ï¼Œduration éœ€è¦ä¹˜ 1000
            const endTime = currentVoteData.startTime + (currentVoteData.duration * 1000);
            const remaining = endTime - now;
            
            if (remaining > 0) {
                const sec = Math.floor(remaining / 1000);
                document.getElementById('vote-time-display').innerText = `å‰©ä½™æ—¶é—´: ${sec} ç§’`;
            } else {
                document.getElementById('vote-time-display').innerText = "æ—¶é—´åˆ°ï¼Œæ­£åœ¨ç»“ç®—...";
                // è‡ªåŠ¨ç»“æŸ
                if (currentVoteData.active) {
                    voteRef.update({ active: false });
                }
            }
        };
        
        update(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        voteTimer = setInterval(update, 1000);
    }

    // è®¾ç½®ç›¸å…³é€»è¾‘
    function openVoteSettings() {
        document.getElementById('vote-settings-modal').style.display = 'flex';
        loadVoteSettingsUI();
    }
    
    function closeVoteSettings() {
        document.getElementById('vote-settings-modal').style.display = 'none';
    }

    function loadVoteSettingsUI() {
        if (!currentVoteData) return;
        document.getElementById('vote-duration').value = currentVoteData.duration || 60;
        
        const list = document.getElementById('program-list-container');
        list.innerHTML = '';
        (currentVoteData.programs || []).forEach((p, idx) => {
            const div = document.createElement('div');
            div.className = 'program-list-item';
            div.innerHTML = `
                <input type="text" value="${p.name}" class="prog-name">
                <input type="text" value="${p.performer||''}" class="prog-perf" placeholder="è¡¨æ¼”è€…">
                <button onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            list.appendChild(div);
        });
    }
    
    function addProgramItem() {
        const div = document.createElement('div');
        div.className = 'program-list-item';
        div.innerHTML = `<input type="text" class="prog-name" placeholder="èŠ‚ç›®å"><input type="text" class="prog-perf" placeholder="è¡¨æ¼”è€…"><button onclick="this.parentElement.remove()">åˆ é™¤</button>`;
        document.getElementById('program-list-container').appendChild(div);
    }

    function saveVoteSettings() {
        const duration = parseInt(document.getElementById('vote-duration').value);
        const inputs = document.querySelectorAll('.program-list-item');
        const newPrograms = [];
        
        inputs.forEach(div => {
            const name = div.querySelector('.prog-name').value;
            const perf = div.querySelector('.prog-perf').value;
            if (name) newPrograms.push({ name: name, performer: perf, votes: 0 });
        });
        
        voteRef.update({
            duration: duration,
            programs: newPrograms
        });
        closeVoteSettings();
    }

    function openVotePanel() { document.getElementById('vote-modal').style.display = 'flex'; }
    function closeVotePanel() { document.getElementById('vote-modal').style.display = 'none'; }

    function generateVoteQRCode() {
        const modal = document.getElementById('qrcode-modal');
        const box = document.getElementById('qrcode');
        const urlSpan = document.getElementById('vote-url');
        
        // è‡ªåŠ¨è¯†åˆ« vote.html åœ°å€
        const url = window.location.href.replace(/index\.html$/, 'vote.html');
        urlSpan.innerText = url;
        box.innerHTML = '';
        
        if (typeof QRCode !== 'undefined') {
            new QRCode(box, { text: url, width: 256, height: 256 });
        } else {
            box.innerText = "è¯·ç¡®ä¿å·²åŠ è½½ qrcode.min.js";
        }
        modal.style.display = 'flex';
    }
</script>
</body>
</html>
