<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´ä¼šèŠ‚ç›®æŠ•ç¥¨ - èº«ä»½éªŒè¯ç‰ˆ</title>
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@700&display=swap" rel="stylesheet">
    
    <!-- æ·»åŠ favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¯</text></svg>">
    
    <style>
        :root {
            --neon-purple: #b900ff;
            --neon-blue: #00eaff;
            --neon-pink: #ff0055;
            --neon-gold: #ffd700;
            --bg-dark: #0b0d17;
            --panel-bg: rgba(5, 5, 10, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, 
                #0b0d17 0%, 
                #090979 25%, 
                #00d4ff 50%, 
                #ff00ff 75%, 
                #0b0d17 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            background-attachment: fixed;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.3);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-blue), transparent);
            animation: scanline 3s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-gold);
            font-size: 3rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .subtitle {
            color: var(--neon-blue);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid var(--neon-purple);
            backdrop-filter: blur(5px);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
        }

        .status-dot.active {
            background: #2ed573;
            box-shadow: 0 0 10px #2ed573;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .time-remaining {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem;
            color: var(--neon-blue);
            font-weight: bold;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 40px;
            border: 2px solid var(--neon-blue);
            margin: 40px 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 40px rgba(0, 234, 255, 0.3);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .login-icon {
            font-size: 4rem;
            margin-bottom: 30px;
            text-align: center;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .login-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-gold);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .login-message {
            color: var(--neon-blue);
            font-size: 1.2rem;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: var(--neon-blue);
            margin-bottom: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            color: #fff;
            font-size: 1.1rem;
            font-family: 'Microsoft YaHei', sans-serif;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--neon-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .form-control option {
            background: #0b0d17;
            color: #fff;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            border: none;
            border-radius: 10px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 20px;
        }

        .btn-login:hover {
            transform: scale(1.03);
            box-shadow: 0 0 30px var(--neon-purple);
        }

        .btn-login:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: var(--neon-pink);
            text-align: center;
            margin-top: 15px;
            font-size: 1rem;
            min-height: 24px;
        }

        .security-note {
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--neon-gold);
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            color: #ccc;
        }

        /* ç­‰å¾…æŠ•ç¥¨ç»“æœæ ·å¼ */
        .waiting-container {
            text-align: center;
            padding: 60px 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            border: 2px solid var(--neon-blue);
            margin: 40px 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 40px rgba(0, 234, 255, 0.3);
        }

        .waiting-icon {
            font-size: 5rem;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        .waiting-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-gold);
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .waiting-message {
            color: var(--neon-blue);
            font-size: 1.2rem;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 234, 255, 0.3);
            border-top: 4px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å·²æŠ•ç¥¨ç¡®è®¤é¡µé¢æ ·å¼ */
        .confirmation-container {
            text-align: center;
            padding: 80px 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            border: 2px solid var(--neon-gold);
            margin: 40px 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .confirmation-icon {
            font-size: 6rem;
            margin-bottom: 30px;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .confirmation-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-gold);
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .confirmation-message {
            color: #fff;
            font-size: 1.3rem;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto 40px;
        }

        .confirmation-details {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 30px auto;
            max-width: 400px;
            border: 1px solid var(--neon-blue);
        }

        .confirmation-details p {
            margin: 10px 0;
            color: #aaa;
            font-size: 1rem;
        }

        .confirmation-details strong {
            color: var(--neon-blue);
        }

        /* æŠ•ç¥¨ç•Œé¢æ ·å¼ */
        .voting-container {
            display: none;
        }

        .programs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .program-card {
            background: rgba(15, 15, 30, 0.85);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .program-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .program-card:hover::before {
            left: 100%;
        }

        .program-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-color: var(--neon-blue);
        }

        .program-card.selected {
            border-color: var(--neon-gold);
            background: rgba(30, 30, 50, 0.9);
        }

        .program-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--neon-gold);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 15px var(--neon-gold);
        }

        .program-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        .program-title {
            font-size: 1.4rem;
            color: #fff;
            margin-bottom: 15px;
            font-family: 'Orbitron', sans-serif;
            min-height: 60px;
        }

        .program-description {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .vote-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .vote-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .vote-btn:hover::before {
            left: 100%;
        }

        .vote-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 0 20px var(--neon-purple);
        }

        .vote-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .vote-btn.selected {
            background: linear-gradient(90deg, var(--neon-gold), #ff9500);
        }

        .vote-btn.selected:hover {
            box-shadow: 0 0 20px var(--neon-gold);
        }

        .vote-count {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--neon-blue);
        }

        .voting-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid var(--neon-purple);
            backdrop-filter: blur(5px);
        }

        .voting-info p {
            margin: 5px 0;
            color: #aaa;
        }

        .voting-info .highlight {
            color: var(--neon-gold);
            font-weight: bold;
        }

        .voter-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid var(--neon-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .voter-name {
            font-size: 1.2rem;
            color: var(--neon-gold);
            font-family: 'Orbitron', sans-serif;
        }

        .device-id {
            font-size: 0.9rem;
            color: #aaa;
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #submit-votes-btn {
            display: block;
            margin: 30px auto;
            max-width: 300px;
        }

        /* æŠ•ç¥¨ç»“æœæ ·å¼ */
        .results-section {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            margin-top: 40px;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .results-section h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-gold);
            text-align: center;
            margin-bottom: 25px;
            font-size: 2rem;
        }

        .results-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .result-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--neon-blue);
            transition: transform 0.3s ease;
        }

        .result-item:hover {
            transform: translateX(5px);
        }

        .result-item.top-3 {
            border-left-color: var(--neon-gold);
            background: rgba(255, 215, 0, 0.05);
        }

        .result-rank {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid var(--neon-blue);
        }

        .top-3 .result-rank {
            border-color: var(--neon-gold);
            background: rgba(255, 215, 0, 0.1);
            color: var(--neon-gold);
        }

        .result-content {
            flex: 1;
        }

        .result-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #fff;
        }

        .result-votes {
            font-size: 0.9rem;
            color: var(--neon-blue);
        }

        .result-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }

        .result-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            border-radius: 10px;
            transition: width 1s ease;
        }

        .top-3 .result-fill {
            background: linear-gradient(90deg, var(--neon-gold), #ff9500);
        }

        .result-percentage {
            position: absolute;
            right: 10px;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #fff;
            font-family: 'Orbitron', sans-serif;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #aaa;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--neon-blue);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 234, 255, 0.3);
            border-top: 4px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error-message-container {
            text-align: center;
            padding: 30px;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff4757;
            border-radius: 10px;
            margin: 20px 0;
            color: #ff6b81;
        }

        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 213, 115, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(46, 213, 115, 0.3);
            backdrop-filter: blur(5px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .programs-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .login-container {
                padding: 20px;
            }
            
            .waiting-title, .confirmation-title {
                font-size: 2rem;
            }
            
            .voter-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¹´ä¼šèŠ‚ç›®æŠ•ç¥¨ç³»ç»Ÿ</h1>
            <div class="subtitle" id="status-subtitle">è¯·å…ˆéªŒè¯æ‚¨çš„èº«ä»½</div>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="status-text">æ­£åœ¨åˆå§‹åŒ–...</span>
                </div>
                <div class="time-remaining" id="time-remaining">--:--</div>
            </div>
        </header>

        <main>
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <span id="loading-text">æ­£åœ¨åˆå§‹åŒ–æŠ•ç¥¨ç³»ç»Ÿ...</span>
                <div id="loading-details" style="font-size: 14px; color: #aaa; margin-top: 10px;"></div>
            </div>

            <!-- é”™è¯¯æ¶ˆæ¯ -->
            <div id="error-message" class="error-message-container" style="display: none;">
                <div id="error-content">æ— æ³•è¿æ¥æŠ•ç¥¨ç³»ç»Ÿï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚</div>
                <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: var(--neon-blue); color: #000; border: none; border-radius: 5px; cursor: pointer;">é‡è¯•</button>
            </div>

            <!-- ç™»å½•é¡µé¢ -->
            <div id="login-container" class="login-container" style="display: none;">
                <div class="login-icon">ğŸ”</div>
                <h2 class="login-title">èº«ä»½éªŒè¯</h2>
                <p class="login-message">è¯·é€‰æ‹©æ‚¨çš„å§“åä»¥è¿›è¡ŒæŠ•ç¥¨éªŒè¯</p>
                
                <div class="form-group">
                    <label for="employee-select">é€‰æ‹©æ‚¨çš„å§“åï¼š</label>
                    <select id="employee-select" class="form-control">
                        <option value="">è¯·é€‰æ‹©...</option>
                        <!-- å‘˜å·¥åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="employee-pin">éªŒè¯ç ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input type="text" id="employee-pin" class="form-control" placeholder="å¦‚æœ‰éªŒè¯ç è¯·åœ¨æ­¤è¾“å…¥" maxlength="6">
                </div>
                
                <div id="login-error" class="error-message"></div>
                
                <button id="login-btn" class="btn-login">å¼€å§‹æŠ•ç¥¨</button>
                
                <div class="security-note">
                    <p>ğŸ’¡ å®‰å…¨æç¤ºï¼š</p>
                    <p>â€¢ æ¯ä¸ªå‘˜å·¥åªèƒ½æŠ•ç¥¨ä¸€æ¬¡</p>
                    <p>â€¢ æŠ•ç¥¨è®°å½•å°†ä¸æ‚¨çš„å§“åå…³è”</p>
                    <p>â€¢ è¯·å‹¿å°†æ‚¨çš„æŠ•ç¥¨æƒé™ç»™ä»–äººä½¿ç”¨</p>
                </div>
            </div>

            <!-- ç­‰å¾…æŠ•ç¥¨ç»“æœ -->
            <div id="waiting-container" class="waiting-container" style="display: none;">
                <div class="waiting-icon">â³</div>
                <h2 class="waiting-title">ç­‰å¾…æŠ•ç¥¨ç»“æœ</h2>
                <p class="waiting-message">
                    æŠ•ç¥¨æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…æŠ•ç¥¨ç»“æŸã€‚<br>
                    æŠ•ç¥¨ç»“æŸåï¼Œå°†åœ¨æ­¤é¡µé¢æ˜¾ç¤ºæœ€ç»ˆæŠ•ç¥¨ç»“æœã€‚
                </p>
                <div class="loading-spinner"></div>
                <p id="waiting-status" style="color: var(--neon-blue); margin-top: 20px; font-size: 1rem;"></p>
            </div>

            <!-- å·²æŠ•ç¥¨ç¡®è®¤é¡µé¢ -->
            <div id="confirmation-container" class="confirmation-container" style="display: none;">
                <div class="confirmation-icon">âœ…</div>
                <h2 class="confirmation-title">æŠ•ç¥¨æˆåŠŸï¼</h2>
                <p class="confirmation-message">
                    æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼æ‚¨çš„æŠ•ç¥¨å·²æˆåŠŸæäº¤ã€‚<br>
                    è¯·ç­‰å¾…æŠ•ç¥¨ç»“æŸæŸ¥çœ‹æœ€ç»ˆç»“æœã€‚
                </p>
                
                <div class="confirmation-details">
                    <p><strong>æŠ•ç¥¨äººï¼š</strong><span id="confirmed-name"></span></p>
                    <p><strong>æŠ•ç¥¨æ—¶é—´ï¼š</strong><span id="confirmed-time"></span></p>
                    <p><strong>æŠ•ç¥¨è®¾å¤‡ï¼š</strong><span id="confirmed-device"></span></p>
                </div>
                
                <div style="color: #aaa; font-size: 1rem; margin-top: 20px;">
                    æŠ•ç¥¨ç»“æŸåï¼Œæ­¤é¡µé¢å°†è‡ªåŠ¨æ˜¾ç¤ºæŠ•ç¥¨ç»“æœã€‚
                </div>
            </div>

            <!-- æŠ•ç¥¨ç•Œé¢ -->
            <div id="voting-container" class="voting-container">
                <div class="voter-info">
                    <div class="voter-name">æŠ•ç¥¨äººï¼š<span id="current-voter-name"></span></div>
                    <div class="device-id">è®¾å¤‡IDï¼š<span id="current-device-id"></span></div>
                </div>
                
                <div class="voting-info">
                    <p>æ¯äººæœ€å¤šå¯æŠ• <span id="max-votes" class="highlight">1</span> ç¥¨</p>
                    <p>æ‚¨å·²é€‰æ‹© <span id="selected-count" class="highlight">0</span> ä¸ªèŠ‚ç›®</p>
                </div>

                <div id="programs-container" class="programs-grid">
                    <!-- èŠ‚ç›®å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <button id="submit-votes-btn" class="vote-btn">æäº¤æŠ•ç¥¨</button>
            </div>

            <!-- æŠ•ç¥¨ç»“æœ -->
            <div id="results-section" class="results-section" style="display: none;">
                <h2>æŠ•ç¥¨ç»“æœ</h2>
                <div id="results-container" class="results-grid">
                    <!-- ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </main>

        <footer>
            <p>å¹´ä¼šèŠ‚ç›®æŠ•ç¥¨ç³»ç»Ÿ &copy; 2023 | æŠ€æœ¯æ”¯æŒï¼šå¹´ä¼šç»„å§”ä¼š</p>
            <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">æ¯ä¸ªå‘˜å·¥é™æŠ•ä¸€æ¬¡ï¼Œè¯·è°¨æ…é€‰æ‹©æ‚¨å–œæ¬¢çš„èŠ‚ç›®</p>
        </footer>
    </div>

    <!-- å¼‚æ­¥åŠ è½½Firebase SDK -->
    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDjZVXYj69RmxlXceo8nWfvb19dPiMCQIY",
            authDomain: "annual-vote.firebaseapp.com",
            databaseURL: "https://annual-vote-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "annual-vote",
            storageBucket: "annual-vote.firebasestorage.app",
            messagingSenderId: "733592758408",
            appId: "1:733592758408:web:e5f5212a8392f298eb573d",
            measurementId: "G-KDQ31YVGGX"
        };

        // å…¨å±€å˜é‡
        let db;
        let programsRef;
        let votesRef;
        let controlRef;
        let voteSettingsRef;
        let employeesRef; // æ–°å¢ï¼šå‘˜å·¥åå•å¼•ç”¨
        
        let selectedPrograms = new Set();
        let maxVotesPerUser = 1;
        let isVotingActive = false;
        let voteTimer = null;
        let deviceId = null;
        let hasVoted = false;
        let programsData = {};
        let employeesData = {}; // æ–°å¢ï¼šå‘˜å·¥æ•°æ®
        let programsListener = null;
        let controlListener = null;
        let lastControlData = null;
        let currentSessionId = null;
        let lastVoteCheckTime = 0;
        let currentEmployee = null; // æ–°å¢ï¼šå½“å‰æŠ•ç¥¨å‘˜å·¥

        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoadingStatus(message, detail = '') {
            const loadingText = document.getElementById('loading-text');
            const loadingDetails = document.getElementById('loading-details');
            
            if (loadingText) loadingText.textContent = message;
            if (loadingDetails && detail) loadingDetails.textContent = detail;
        }

        // ç”Ÿæˆå¢å¼ºè®¾å¤‡ID - ç»“åˆå¤šä¸ªå› ç´ 
        function generateEnhancedDeviceId() {
            try {
                const components = [];
                
                // 1. æµè§ˆå™¨æŒ‡çº¹
                components.push(navigator.userAgent);
                components.push(navigator.language);
                components.push(screen.colorDepth);
                components.push(screen.width + 'x' + screen.height);
                components.push(new Date().getTimezoneOffset());
                components.push(navigator.platform);
                
                // 2. CanvasæŒ‡çº¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 50;
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125,1,62,20);
                ctx.fillStyle = '#069';
                ctx.fillText('BrowserFingerprint', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText('BrowserFingerprint', 4, 17);
                
                const canvasData = canvas.toDataURL();
                components.push(canvasData.substring(canvasData.length - 100));
                
                // 3. WebGLæŒ‡çº¹ï¼ˆå¦‚æœæœ‰ï¼‰
                if (navigator.gpu) {
                    components.push('webgl');
                }
                
                // 4. æ—¶é—´æˆ³ï¼ˆç¡®ä¿å”¯ä¸€æ€§ï¼‰
                components.push(Date.now());
                
                // 5. éšæœºæ•°
                components.push(Math.random().toString(36).substr(2, 9));
                
                // ç”Ÿæˆå“ˆå¸Œ
                const combined = components.join('|');
                let hash = 0;
                for (let i = 0; i < combined.length; i++) {
                    const char = combined.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                
                return 'vote_device_' + Math.abs(hash).toString(36) + '_' + Date.now().toString(36).substr(2, 6);
                
            } catch (error) {
                console.error('ç”Ÿæˆè®¾å¤‡IDå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
                // å¤‡ç”¨æ–¹æ¡ˆ
                return 'vote_device_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 12);
            }
        }

        // æ£€æŸ¥URLå‚æ•°éªŒè¯åˆæ³•æ€§
        function validateURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const session = urlParams.get('session');
            const timestamp = urlParams.get('timestamp');
            const source = urlParams.get('source');
            
            // æ£€æŸ¥å¿…éœ€å‚æ•°
            if (!session || !timestamp) {
                return { valid: false, reason: 'æ— æ•ˆçš„æŠ•ç¥¨é“¾æ¥' };
            }
            
            // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼ˆ24å°æ—¶å†…ï¼‰
            const urlTime = parseInt(timestamp);
            const now = Date.now();
            const timeDiff = now - urlTime;
            
            if (timeDiff > 24 * 60 * 60 * 1000) { // 24å°æ—¶
                return { valid: false, reason: 'æŠ•ç¥¨é“¾æ¥å·²è¿‡æœŸ' };
            }
            
            // æ£€æŸ¥æ¥æº
            if (source !== 'official') {
                return { valid: false, reason: 'éå®˜æ–¹æŠ•ç¥¨é“¾æ¥' };
            }
            
            return { valid: true, session: session };
        }

        // æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨ - å¢å¼ºç‰ˆ
        async function checkHasVoted() {
            if (!currentEmployee) {
                return false;
            }
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            const voteKey = `annual_vote_${currentEmployee.id}`;
            const voteDataStr = localStorage.getItem(voteKey);
            
            if (!voteDataStr) {
                return false;
            }
            
            try {
                const voteData = JSON.parse(voteDataStr);
                
                // è·å–å½“å‰çš„ä¼šè¯ID
                const controlSnapshot = await controlRef.once('value');
                const controlData = controlSnapshot.val() || {};
                const currentSessionId = controlData.sessionId;
                
                // å¦‚æœä¼šè¯IDä¸åŒ¹é…ï¼Œæ¸…é™¤æœ¬åœ°è®°å½•
                if (currentSessionId && voteData.sessionId !== currentSessionId) {
                    console.log('ä¼šè¯IDä¸åŒ¹é…ï¼Œæ¸…é™¤æœ¬åœ°æŠ•ç¥¨è®°å½•');
                    localStorage.removeItem(voteKey);
                    
                    // æ›´æ–°Firebaseä¸­çš„å‘˜å·¥æŠ•ç¥¨çŠ¶æ€
                    if (currentEmployee && currentEmployee.id) {
                        await employeesRef.child(currentEmployee.id).update({
                            hasVoted: false,
                            voteDevice: null,
                            voteTime: null,
                            lastUpdate: Date.now()
                        });
                    }
                    
                    return false;
                }
                
                // å¦‚æœæŠ•ç¥¨æ—¶é—´è¶…è¿‡24å°æ—¶ï¼Œä¹Ÿæ¸…é™¤è®°å½•
                const voteTime = voteData.timestamp || 0;
                const now = Date.now();
                if (now - voteTime > 24 * 60 * 60 * 1000) {
                    console.log('æŠ•ç¥¨è®°å½•è¶…è¿‡24å°æ—¶ï¼Œæ¸…é™¤æœ¬åœ°è®°å½•');
                    localStorage.removeItem(voteKey);
                    
                    // æ›´æ–°Firebaseä¸­çš„å‘˜å·¥æŠ•ç¥¨çŠ¶æ€
                    if (currentEmployee && currentEmployee.id) {
                        await employeesRef.child(currentEmployee.id).update({
                            hasVoted: false,
                            voteDevice: null,
                            voteTime: null,
                            lastUpdate: Date.now()
                        });
                    }
                    
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥æŠ•ç¥¨è®°å½•æ—¶å‡ºé”™:', error);
                localStorage.removeItem(voteKey);
                return false;
            }
        }

        // æ ‡è®°å·²æŠ•ç¥¨ - å¢å¼ºç‰ˆ
        async function markAsVoted(voteData) {
            if (!currentEmployee) return;
            
            const voteKey = `annual_vote_${currentEmployee.id}`;
            
            // ä¿å­˜æŠ•ç¥¨æ•°æ®åˆ°localStorage
            localStorage.setItem(voteKey, JSON.stringify({
                ...voteData,
                sessionId: currentSessionId,
                timestamp: Date.now(),
                employeeId: currentEmployee.id,
                employeeName: currentEmployee.name
            }));
            
            // æ›´æ–°Firebaseä¸­çš„å‘˜å·¥æŠ•ç¥¨çŠ¶æ€
            if (currentEmployee && currentEmployee.id) {
                await employeesRef.child(currentEmployee.id).update({
                    hasVoted: true,
                    voteDevice: deviceId,
                    voteTime: Date.now(),
                    lastUpdate: Date.now()
                });
            }
            
            hasVoted = true;
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // éªŒè¯URLå‚æ•°
                const urlValidation = validateURLParams();
                if (!urlValidation.valid) {
                    showError(urlValidation.reason);
                    return;
                }
                
                // ç”Ÿæˆè®¾å¤‡ID
                deviceId = generateEnhancedDeviceId();
                console.log('è®¾å¤‡ID:', deviceId);
                
                updateLoadingStatus('æ­£åœ¨è¿æ¥æŠ•ç¥¨ç³»ç»Ÿ...');
                
                // åŠ¨æ€åŠ è½½Firebase
                await loadFirebase();
                
                updateLoadingStatus('æ­£åœ¨åˆå§‹åŒ–æŠ•ç¥¨ç³»ç»Ÿ...');
                await initializeFirebase();
                
                // åŠ è½½å‘˜å·¥åå•
                await loadEmployees();
                
                // ç›‘å¬æŠ•ç¥¨çŠ¶æ€å˜åŒ–
                setupVoteListeners();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });

        // åŠ è½½Firebase SDK
        function loadFirebase() {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
                if (typeof firebase !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script1 = document.createElement('script');
                script1.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js';
                script1.onload = () => {
                    const script2 = document.createElement('script');
                    script2.src = 'https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js';
                    script2.onload = resolve;
                    script2.onerror = reject;
                    document.head.appendChild(script2);
                };
                script1.onerror = reject;
                document.head.appendChild(script1);
            });
        }

        // åˆå§‹åŒ–Firebase
        async function initializeFirebase() {
            try {
                // æ£€æŸ¥Firebase SDKæ˜¯å¦åŠ è½½
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK æœªåŠ è½½');
                }
                
                updateLoadingStatus('æ­£åœ¨è¿æ¥æ•°æ®åº“...');
                
                // åˆå§‹åŒ–Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                // è·å–æ•°æ®åº“å¼•ç”¨
                db = firebase.database();
                votesRef = db.ref('votes');
                programsRef = db.ref('programs');
                controlRef = db.ref('vote_control');
                voteSettingsRef = db.ref('vote_settings');
                employeesRef = db.ref('employees'); // å‘˜å·¥åå•
                
                console.log('Firebaseåˆå§‹åŒ–æˆåŠŸ');
                
            } catch (error) {
                console.error('Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½å‘˜å·¥åå•
        async function loadEmployees() {
            try {
                if (!employeesRef) {
                    console.warn('å‘˜å·¥åå•å¼•ç”¨æœªåˆå§‹åŒ–');
                    return;
                }
                
                const snapshot = await employeesRef.once('value');
                employeesData = snapshot.val() || {};
                
                console.log(`åŠ è½½äº† ${Object.keys(employeesData).length} åå‘˜å·¥æ•°æ®`);
                
                // å¡«å……å‘˜å·¥é€‰æ‹©æ¡†
                populateEmployeeSelect();
                
                // æ˜¾ç¤ºç™»å½•ç•Œé¢
                showLoginPage();
                
            } catch (error) {
                console.error('åŠ è½½å‘˜å·¥åå•å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½å‘˜å·¥åå•ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
            }
        }

        // å¡«å……å‘˜å·¥é€‰æ‹©æ¡†
        function populateEmployeeSelect() {
            const select = document.getElementById('employee-select');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
            
            // æŒ‰å§“åæ’åº
            const employeesArray = Object.values(employeesData).sort((a, b) => {
                return a.name.localeCompare(b.name, 'zh-CN');
            });
            
            employeesArray.forEach(employee => {
                if (!employee.hasVoted) {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    select.appendChild(option);
                }
            });
            
            // å¦‚æœæ²¡æœ‰æœªæŠ•ç¥¨çš„å‘˜å·¥ï¼Œæ˜¾ç¤ºæç¤º
            if (employeesArray.filter(e => !e.hasVoted).length === 0) {
                select.innerHTML = '<option value="">æ‰€æœ‰å‘˜å·¥å‡å·²æŠ•ç¥¨</option>';
                document.getElementById('login-btn').disabled = true;
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            hideAllContainers();
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('login-btn').addEventListener('click', handleLogin);
        }

        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const select = document.getElementById('employee-select');
            const pinInput = document.getElementById('employee-pin');
            const errorDiv = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');
            
            const employeeId = select.value;
            const pin = pinInput.value.trim();
            
            // éªŒè¯è¾“å…¥
            if (!employeeId) {
                errorDiv.textContent = 'è¯·é€‰æ‹©æ‚¨çš„å§“å';
                return;
            }
            
            // éªŒè¯å‘˜å·¥æ˜¯å¦å­˜åœ¨ä¸”æœªæŠ•ç¥¨
            const employee = employeesData[employeeId];
            if (!employee) {
                errorDiv.textContent = 'é€‰æ‹©çš„å‘˜å·¥ä¸å­˜åœ¨';
                return;
            }
            
            if (employee.hasVoted) {
                errorDiv.textContent = 'è¯¥å‘˜å·¥å·²æŠ•ç¥¨ï¼Œæ¯äººé™æŠ•ä¸€æ¬¡';
                return;
            }
            
            // å¯é€‰éªŒè¯ç éªŒè¯
            if (pin && employee.pinCode && employee.pinCode !== pin) {
                errorDiv.textContent = 'éªŒè¯ç é”™è¯¯';
                return;
            }
            
            // ç¦ç”¨ç™»å½•æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            loginBtn.disabled = true;
            loginBtn.textContent = 'éªŒè¯ä¸­...';
            
            try {
                // è®¾ç½®å½“å‰å‘˜å·¥
                currentEmployee = {
                    id: employeeId,
                    name: employee.name,
                    ...employee
                };
                
                // æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
                hasVoted = await checkHasVoted();
                
                if (hasVoted) {
                    errorDiv.textContent = 'æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†';
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'å¼€å§‹æŠ•ç¥¨';
                    return;
                }
                
                // ç™»å½•æˆåŠŸï¼Œè¿›å…¥æŠ•ç¥¨æµç¨‹
                console.log(`å‘˜å·¥ ${employee.name} ç™»å½•æˆåŠŸ`);
                
                // æ›´æ–°UIæ˜¾ç¤ºå½“å‰æŠ•ç¥¨äºº
                document.getElementById('current-voter-name').textContent = employee.name;
                document.getElementById('current-device-id').textContent = deviceId.substring(0, 16) + '...';
                
                // æ ¹æ®æŠ•ç¥¨çŠ¶æ€æ˜¾ç¤ºç›¸åº”ç•Œé¢
                if (isVotingActive && !hasVoted) {
                    loadVotingInterface();
                } else if (hasVoted) {
                    showConfirmationPage();
                } else {
                    showWaitingForVote();
                }
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                errorDiv.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                loginBtn.disabled = false;
                loginBtn.textContent = 'å¼€å§‹æŠ•ç¥¨';
            }
        }

        // è®¾ç½®æŠ•ç¥¨ç›‘å¬å™¨
        function setupVoteListeners() {
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
            if (programsListener) {
                programsRef.off('value', programsListener);
            }
            if (controlListener) {
                controlRef.off('value', controlListener);
            }
            
            // ç›‘å¬æŠ•ç¥¨æ§åˆ¶çŠ¶æ€
            controlListener = controlRef.on('value', async (snapshot) => {
                const controlData = snapshot.val();
                
                if (controlData) {
                    // ç¼“å­˜æ§åˆ¶æ•°æ®
                    lastControlData = controlData;
                    currentSessionId = controlData.sessionId;
                    
                    isVotingActive = controlData.isActive || false;
                    
                    updateStatusUI();
                    
                    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºç›¸åº”ç•Œé¢ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
                    if (currentEmployee) {
                        // æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
                        const now = Date.now();
                        if (now - lastVoteCheckTime > 5000) {
                            lastVoteCheckTime = now;
                            hasVoted = await checkHasVoted();
                        }
                        
                        if (hasVoted) {
                            showConfirmationPage();
                        } else if (isVotingActive) {
                            loadVotingInterface();
                        } else {
                            if (controlData.endTime) {
                                const serverTimeNow = controlData.serverTime ? 
                                    controlData.serverTime + (Date.now() - controlData.lastUpdate) : 
                                    Date.now();
                                
                                if (serverTimeNow > controlData.endTime) {
                                    loadFinalResults();
                                } else {
                                    showWaitingForVote();
                                }
                            } else {
                                showWaitingForVote();
                            }
                        }
                        
                        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
                        updateTimeDisplay();
                    }
                    
                } else {
                    // æ²¡æœ‰æ§åˆ¶æ•°æ®ï¼Œé»˜è®¤æ˜¾ç¤ºç­‰å¾…
                    if (currentEmployee) {
                        showWaitingForVote();
                    }
                }
            }, (error) => {
                console.error('ç›‘å¬æŠ•ç¥¨çŠ¶æ€å¤±è´¥:', error);
                showError('æ— æ³•è·å–æŠ•ç¥¨çŠ¶æ€');
            });
            
            // ç›‘å¬è¿æ¥çŠ¶æ€
            const connectedRef = db.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    console.log('Firebaseè¿æ¥æˆåŠŸ');
                    updateLoadingStatus('è¿æ¥æˆåŠŸ', 'æ­£åœ¨åŒæ­¥æŠ•ç¥¨æ•°æ®...');
                } else {
                    console.log('Firebaseè¿æ¥æ–­å¼€');
                    updateLoadingStatus('è¿æ¥æ–­å¼€', 'æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
                }
            });
        }

        // æ›´æ–°çŠ¶æ€UI
        function updateStatusUI() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const subtitle = document.getElementById('status-subtitle');
            
            if (isVotingActive) {
                statusDot.classList.add('active');
                statusText.textContent = 'æŠ•ç¥¨è¿›è¡Œä¸­';
                if (currentEmployee) {
                    subtitle.textContent = `${currentEmployee.name}ï¼Œè¯·é€‰æ‹©æ‚¨å–œæ¬¢çš„èŠ‚ç›®`;
                } else {
                    subtitle.textContent = 'è¯·é€‰æ‹©æ‚¨å–œæ¬¢çš„èŠ‚ç›®';
                }
            } else {
                statusDot.classList.remove('active');
                if (lastControlData && lastControlData.endTime) {
                    const serverTimeNow = lastControlData.serverTime ? 
                        lastControlData.serverTime + (Date.now() - lastControlData.lastUpdate) : 
                        Date.now();
                    
                    if (serverTimeNow > lastControlData.endTime) {
                        statusText.textContent = 'æŠ•ç¥¨å·²ç»“æŸ';
                        subtitle.textContent = 'æŠ•ç¥¨ç»“æœ';
                    } else {
                        statusText.textContent = 'æŠ•ç¥¨æœªå¼€å§‹';
                        subtitle.textContent = currentEmployee ? `${currentEmployee.name}ï¼Œè¯·ç­‰å¾…æŠ•ç¥¨å¼€å§‹` : 'è¯·ç­‰å¾…æŠ•ç¥¨å¼€å§‹';
                    }
                } else {
                    statusText.textContent = 'æŠ•ç¥¨æœªå¼€å§‹';
                    subtitle.textContent = currentEmployee ? `${currentEmployee.name}ï¼Œè¯·ç­‰å¾…æŠ•ç¥¨å¼€å§‹` : 'è¯·ç­‰å¾…æŠ•ç¥¨å¼€å§‹';
                }
            }
        }

        // æ˜¾ç¤ºç­‰å¾…æŠ•ç¥¨é¡µé¢
        function showWaitingForVote() {
            hideAllContainers();
            document.getElementById('waiting-container').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            const waitingStatus = document.getElementById('waiting-status');
            if (waitingStatus) {
                if (lastControlData && lastControlData.startTime) {
                    waitingStatus.textContent = 'æŠ•ç¥¨å³å°†å¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…...';
                } else {
                    waitingStatus.textContent = 'æŠ•ç¥¨å°šæœªå¼€å§‹ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å¼€å¯æŠ•ç¥¨...';
                }
            }
        }

        // æ˜¾ç¤ºç¡®è®¤é¡µé¢ï¼ˆå·²æŠ•ç¥¨ï¼‰
        function showConfirmationPage() {
            hideAllContainers();
            document.getElementById('confirmation-container').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // æ›´æ–°ç¡®è®¤é¡µé¢ä¿¡æ¯
            if (currentEmployee) {
                document.getElementById('confirmed-name').textContent = currentEmployee.name;
                document.getElementById('confirmed-time').textContent = new Date().toLocaleString('zh-CN');
                document.getElementById('confirmed-device').textContent = deviceId.substring(0, 12) + '...';
            }
            
            // å¦‚æœæŠ•ç¥¨å·²ç»“æŸï¼Œæ˜¾ç¤ºç»“æœ
            if (lastControlData && lastControlData.endTime) {
                const serverTimeNow = lastControlData.serverTime ? 
                    lastControlData.serverTime + (Date.now() - lastControlData.lastUpdate) : 
                    Date.now();
                
                if (serverTimeNow > lastControlData.endTime) {
                    // å»¶è¿ŸåŠ è½½ç»“æœï¼Œè®©ç”¨æˆ·çœ‹åˆ°ç¡®è®¤ä¿¡æ¯
                    setTimeout(() => {
                        loadFinalResults();
                    }, 3000);
                }
            }
        }

        // åŠ è½½æŠ•ç¥¨ç•Œé¢
        function loadVotingInterface() {
            if (!currentEmployee || hasVoted) {
                if (!currentEmployee) {
                    showLoginPage();
                } else {
                    showConfirmationPage();
                }
                return;
            }
            
            hideAllContainers();
            document.getElementById('voting-container').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // åŠ è½½èŠ‚ç›®æ•°æ®
            loadPrograms();
        }

        // åŠ è½½æœ€ç»ˆç»“æœ
        function loadFinalResults() {
            hideAllContainers();
            document.getElementById('results-section').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // åŠ è½½èŠ‚ç›®æ•°æ®å¹¶æ˜¾ç¤ºç»“æœ
            programsRef.once('value').then((snapshot) => {
                const programs = snapshot.val();
                if (programs) {
                    renderResults(programs);
                }
            });
        }

        // éšè—æ‰€æœ‰å®¹å™¨
        function hideAllContainers() {
            const containers = [
                'loading',
                'error-message',
                'login-container',
                'waiting-container',
                'confirmation-container',
                'voting-container',
                'results-section'
            ];
            
            containers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const timeElement = document.getElementById('time-remaining');
            
            if (!lastControlData || !lastControlData.endTime || !isVotingActive) {
                timeElement.textContent = '--:--';
                // æ¸…é™¤å®šæ—¶å™¨
                if (voteTimer) {
                    clearInterval(voteTimer);
                    voteTimer = null;
                }
                return;
            }
            
            // ä½¿ç”¨ä¸»ç³»ç»Ÿæä¾›çš„æœåŠ¡å™¨æ—¶é—´è¿›è¡Œè®¡ç®—
            const now = Date.now();
            const serverTimeNow = lastControlData.serverTime ? 
                lastControlData.serverTime + (now - lastControlData.lastUpdate) : 
                now;
            const remaining = Math.max(0, lastControlData.endTime - serverTimeNow);
            
            if (remaining <= 0) {
                timeElement.textContent = '00:00';
                isVotingActive = false;
                updateStatusUI();
                // æ¸…é™¤å®šæ—¶å™¨
                if (voteTimer) {
                    clearInterval(voteTimer);
                    voteTimer = null;
                }
                return;
            }
            
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            timeElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // ç¡®ä¿å®šæ—¶å™¨è¿è¡Œ
            if (!voteTimer) {
                voteTimer = setInterval(updateTimeDisplay, 500);
            }
        }

        // åŠ è½½èŠ‚ç›®æ•°æ®
        async function loadPrograms() {
            try {
                // è·å–æŠ•ç¥¨è®¾ç½®
                const settingsSnapshot = await voteSettingsRef.once('value');
                const settings = settingsSnapshot.val() || {};
                maxVotesPerUser = settings.votesPerUser || 1;
                
                // æ›´æ–°UIæ˜¾ç¤º
                document.getElementById('max-votes').textContent = maxVotesPerUser;
                
                // è·å–èŠ‚ç›®æ•°æ®
                const snapshot = await programsRef.once('value');
                programsData = snapshot.val() || {};
                
                // æ¸²æŸ“èŠ‚ç›®åˆ—è¡¨
                renderPrograms();
                
                // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
                document.getElementById('submit-votes-btn').addEventListener('click', submitVotes);
                
            } catch (error) {
                console.error('åŠ è½½èŠ‚ç›®æ•°æ®å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½èŠ‚ç›®åˆ—è¡¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // æ¸²æŸ“èŠ‚ç›®åˆ—è¡¨
        function renderPrograms() {
            const programsContainer = document.getElementById('programs-container');
            programsContainer.innerHTML = '';
            
            selectedPrograms.clear();
            updateSelectedCount();
            
            // å»é‡å¤„ç† - ç¡®ä¿æ²¡æœ‰é‡å¤IDçš„èŠ‚ç›®
            const uniquePrograms = {};
            const seenIds = new Set();
            
            Object.keys(programsData).forEach(key => {
                const program = programsData[key];
                if (program && program.id && !seenIds.has(program.id)) {
                    seenIds.add(program.id);
                    uniquePrograms[key] = program;
                }
            });
            
            // å°†èŠ‚ç›®è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const programsArray = Object.values(uniquePrograms).sort((a, b) => a.id - b.id);
            
            programsArray.forEach(program => {
                const programCard = document.createElement('div');
                programCard.className = 'program-card';
                programCard.dataset.programId = program.id;
                
                programCard.innerHTML = `
                    <div class="program-number">${program.id}</div>
                    <h3 class="program-title">${program.title}</h3>
                    <p class="program-description">${program.description || 'æš‚æ— æè¿°'}</p>
                    <div class="vote-count">å½“å‰ç¥¨æ•°: <span class="highlight">${program.votes || 0}</span></div>
                    <button class="vote-btn" data-program-id="${program.id}">æŠ•ç¥¨</button>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const voteBtn = programCard.querySelector('.vote-btn');
                voteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleVote(program.id);
                });
                
                programCard.addEventListener('click', () => {
                    toggleVote(program.id);
                });
                
                programsContainer.appendChild(programCard);
            });
        }

        // åˆ‡æ¢æŠ•ç¥¨é€‰æ‹©
        function toggleVote(programId) {
            if (selectedPrograms.has(programId)) {
                // å–æ¶ˆé€‰æ‹©
                selectedPrograms.delete(programId);
                const programCard = document.querySelector(`.program-card[data-program-id="${programId}"]`);
                const voteBtn = programCard.querySelector('.vote-btn');
                
                programCard.classList.remove('selected');
                voteBtn.textContent = 'æŠ•ç¥¨';
                voteBtn.classList.remove('selected');
            } else {
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§é€‰æ‹©æ•°é‡
                if (selectedPrograms.size >= maxVotesPerUser) {
                    showMessage(`æ¯äººæœ€å¤šåªèƒ½æŠ•${maxVotesPerUser}ç¥¨`);
                    return;
                }
                
                // é€‰æ‹©
                selectedPrograms.add(programId);
                const programCard = document.querySelector(`.program-card[data-program-id="${programId}"]`);
                const voteBtn = programCard.querySelector('.vote-btn');
                
                programCard.classList.add('selected');
                voteBtn.textContent = 'å–æ¶ˆæŠ•ç¥¨';
                voteBtn.classList.add('selected');
            }
            
            updateSelectedCount();
        }

        // æ›´æ–°å·²é€‰æ‹©æ•°é‡
        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedPrograms.size;
            
            // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
            const submitBtn = document.getElementById('submit-votes-btn');
            if (selectedPrograms.size > 0) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        // æäº¤æŠ•ç¥¨
        async function submitVotes() {
            try {
                if (!currentEmployee) {
                    showMessage('è¯·å…ˆç™»å½•');
                    return;
                }
                
                if (selectedPrograms.size === 0) {
                    showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªèŠ‚ç›®');
                    return;
                }
                
                if (selectedPrograms.size > maxVotesPerUser) {
                    showMessage(`æ¯äººæœ€å¤šåªèƒ½æŠ•${maxVotesPerUser}ç¥¨`);
                    return;
                }
                
                if (!isVotingActive) {
                    showMessage('æŠ•ç¥¨å°šæœªå¼€å§‹æˆ–å·²ç»“æŸ');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨
                if (hasVoted) {
                    showMessage('æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†');
                    return;
                }
                
                // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
                const submitBtn = document.getElementById('submit-votes-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';
                
                // è·å–å½“å‰æ—¶é—´
                const now = Date.now();
                const serverTimeNow = lastControlData.serverTime ? 
                    lastControlData.serverTime + (now - lastControlData.lastUpdate) : 
                    now;
                
                // å‡†å¤‡æŠ•ç¥¨æ•°æ®
                const voteData = {
                    employeeId: currentEmployee.id,
                    employeeName: currentEmployee.name,
                    deviceId: deviceId,
                    selectedPrograms: Array.from(selectedPrograms),
                    timestamp: serverTimeNow,
                    sessionId: currentSessionId
                };
                
                // æ›´æ–°ç¥¨æ•°
                const updatePromises = Array.from(selectedPrograms).map(async (programId) => {
                    const programRef = programsRef.child(programId);
                    // ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
                    await programRef.transaction((currentData) => {
                        if (currentData) {
                            currentData.votes = (currentData.votes || 0) + 1;
                            currentData.lastUpdate = serverTimeNow;
                        }
                        return currentData;
                    });
                });
                
                // ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆ
                await Promise.all(updatePromises);
                
                // ä¿å­˜æŠ•ç¥¨è®°å½•åˆ°æœ¬åœ°å’ŒFirebase
                await markAsVoted(voteData);
                
                // ä¿å­˜æŠ•ç¥¨è®°å½•åˆ°Firebaseï¼ˆç”¨äºç»Ÿè®¡ï¼‰
                try {
                    await votesRef.child(currentEmployee.id).set(voteData);
                } catch (error) {
                    console.warn('ä¿å­˜æŠ•ç¥¨è®°å½•åˆ°äº‘ç«¯å¤±è´¥:', error);
                    // ä¸é˜»æ­¢ç”¨æˆ·æŠ•ç¥¨æˆåŠŸ
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showMessage('æŠ•ç¥¨æˆåŠŸï¼', true);
                
                // æ˜¾ç¤ºç¡®è®¤é¡µé¢
                showConfirmationPage();
                
            } catch (error) {
                console.error('æäº¤æŠ•ç¥¨å¤±è´¥:', error);
                showMessage('æŠ•ç¥¨æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                
                // é‡æ–°å¯ç”¨æäº¤æŒ‰é’®
                const submitBtn = document.getElementById('submit-votes-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤æŠ•ç¥¨';
            }
        }

        // æ¸²æŸ“æŠ•ç¥¨ç»“æœ
        function renderResults(programs) {
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';
            
            // å»é‡å¤„ç†
            const uniquePrograms = {};
            const seenIds = new Set();
            
            Object.keys(programs).forEach(key => {
                const program = programs[key];
                if (program && program.id && !seenIds.has(program.id)) {
                    seenIds.add(program.id);
                    uniquePrograms[key] = program;
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const programsArray = Object.values(uniquePrograms);
            const sortedPrograms = programsArray.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            
            // è®¡ç®—æ€»ç¥¨æ•°
            const totalVotes = sortedPrograms.reduce((sum, program) => sum + (program.votes || 0), 0);
            
            sortedPrograms.forEach((program, index) => {
                const votes = program.votes || 0;
                const percentage = totalVotes > 0 ? (votes / totalVotes) * 100 : 0;
                
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${index < 3 ? 'top-3' : ''}`;
                
                resultItem.innerHTML = `
                    <div class="result-rank">${index + 1}</div>
                    <div class="result-content">
                        <div class="result-title">${program.title}</div>
                        <div class="result-votes">${votes} ç¥¨</div>
                        <div class="result-bar">
                            <div class="result-fill" style="width: ${percentage}%"></div>
                            <div class="result-percentage">${percentage.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
                
                resultsContainer.appendChild(resultItem);
            });
            
            // å¦‚æœæ²¡æœ‰èŠ‚ç›®æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
            if (sortedPrograms.length === 0) {
                resultsContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: #aaa;">æš‚æ— æŠ•ç¥¨æ•°æ®</div>';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, isSuccess = false) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            if (isSuccess) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'success-message';
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 3000);
            } else {
                alert(message);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            hideAllContainers();
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            
            const errorDiv = document.getElementById('error-content');
            if (errorDiv) {
                errorDiv.textContent = message;
            }
        }
    </script>
</body>
</html>
